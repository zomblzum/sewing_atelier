{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Редактирование{% else %}Создание{% endif %} заказа{% endblock %}

{% block extra_head %}
<style>
<style>
.list-group-item {
    cursor: pointer;
    border: 1px solid #dee2e6;
    border-top: none;
    font-size: 14px;
    padding: 8px 12px;
}
.list-group-item:first-child {
    border-top: 1px solid #dee2e6;
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
}
.list-group-item:last-child {
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
}
.list-group-item:hover {
    background-color: #f8f9fa;
}
.position-absolute {
    width: calc(100% - 30px); /* Учитываем padding контейнера */
    left: 15px;
    right: 15px;
}
#customerFirstNameSuggestions,
#customerPhoneSuggestions {
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 4px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('id_category');
    const priceInput = document.getElementById('id_price');
    const plannedDateInput = document.getElementById('id_planned_date');
    const firstNameInput = document.getElementById('id_customer_first_name');
    const phoneInput = document.getElementById('id_customer_phone');
    const firstNameSuggestions = document.getElementById('customerFirstNameSuggestions');
    const phoneSuggestions = document.getElementById('customerPhoneSuggestions');
    
    let customersData = [];
    let debounceTimer;

    // Загружаем список клиентов
    function loadCustomers() {
        fetch('{% url "customer_list_json" %}')
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                customersData = data;
                console.log('Loaded customers:', customersData.length);
            })
            .catch(error => console.error('Error loading customers:', error));
    }

    // Поиск клиентов
    function searchCustomers(field, value) {
        if (!value || value.trim().length < 2) {
            return [];
        }
        
        const searchValue = value.toLowerCase().trim();
        return customersData.filter(customer => {
            if (field === 'first_name') {
                return customer.first_name.toLowerCase().includes(searchValue);
            } else if (field === 'phone') {
                return customer.phone.includes(searchValue);
            }
            return false;
        });
    }

    // Показ подсказок
    function showSuggestions(suggestionsContainer, suggestions, field) {
        suggestionsContainer.innerHTML = '';
        
        if (suggestions.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }
        
        suggestionsContainer.style.display = 'block';
        
        suggestions.slice(0, 10).forEach(customer => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = field === 'first_name' 
                ? `${customer.first_name} <small class="text-muted">${customer.phone}</small>`
                : `${customer.phone} <small class="text-muted">${customer.first_name}</small>`;
            
            item.addEventListener('click', () => {
                firstNameInput.value = customer.first_name;
                phoneInput.value = customer.phone;
                suggestionsContainer.style.display = 'none';
            });
            
            suggestionsContainer.appendChild(item);
        });
    }

    // Обработчики событий для поиска клиентов
    if (firstNameInput && phoneInput) {
        firstNameInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const suggestions = searchCustomers('first_name', this.value);
                showSuggestions(firstNameSuggestions, suggestions, 'first_name');
            }, 300);
        });

        phoneInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const suggestions = searchCustomers('phone', this.value);
                showSuggestions(phoneSuggestions, suggestions, 'phone');
            }, 300);
        });

        // Скрытие подсказок при клике вне
        document.addEventListener('click', function(e) {
            if (firstNameSuggestions && !firstNameInput.contains(e.target) && !firstNameSuggestions.contains(e.target)) {
                firstNameSuggestions.style.display = 'none';
            }
            if (phoneSuggestions && !phoneInput.contains(e.target) && !phoneSuggestions.contains(e.target)) {
                phoneSuggestions.style.display = 'none';
            }
        });

        // Загружаем клиентов при загрузке страницы
        loadCustomers();
    }

    // Существующий код для категорий и цены
    if (categorySelect && priceInput) {
        const originalPrice = priceInput.value;
        let priceWasManuallyChanged = false;
        
        priceInput.addEventListener('input', function() {
            priceWasManuallyChanged = true;
        });
        
        categorySelect.addEventListener('change', function() {
            if (!priceWasManuallyChanged || priceInput.value === originalPrice || priceInput.value === '') {
                const selectedOption = categorySelect.options[categorySelect.selectedIndex];
                const price = selectedOption.getAttribute('data-price');
                if (price) {
                    priceInput.value = price;
                }
            }
        });
        
        // Инициализируем цену при загрузке, если категория выбрана
        if (categorySelect.value) {
            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            if (price && (!priceWasManuallyChanged || priceInput.value === originalPrice || priceInput.value === '')) {
                priceInput.value = price;
            }
        }
    }

    // Отладочная информация
    console.log('Planned date input value:', plannedDateInput?.value);
});
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h1>{% if form.instance.pk %}Редактирование заказа{% else %}Создание заказа{% endif %}</h1>
        
        <form method="post" id="orderForm">
            {% csrf_token %}
            
            <div class="card mb-4">
                <div class="card-header">Основная информация</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">Название заказа</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="text-danger">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.customer_first_name.id_for_label }}" class="form-label">Имя клиента</label>
                            {{ form.customer_first_name }}
                            <div id="customerFirstNameSuggestions" class="list-group position-absolute" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                            {% if form.customer_first_name.errors %}
                            <div class="text-danger">{{ form.customer_first_name.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.customer_phone.id_for_label }}" class="form-label">Телефон клиента</label>
                            {{ form.customer_phone }}
                            <div id="customerPhoneSuggestions" class="list-group position-absolute" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                            {% if form.customer_phone.errors %}
                            <div class="text-danger">{{ form.customer_phone.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.category.id_for_label }}" class="form-label">Категория</label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                <div class="text-danger">{{ form.category.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">Статус</label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                <div class="text-danger">{{ form.status.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.price.id_for_label }}" class="form-label">Цена (руб.)</label>
                                {{ form.price }}
                                {% if form.price.errors %}
                                <div class="text-danger">{{ form.price.errors }}</div>
                                {% endif %}
                                <div class="form-text">Автоматически заполняется из категории</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.planned_minutes.id_for_label }}" class="form-label">Планируемое время (мин.)</label>
                                {{ form.planned_minutes }}
                                {% if form.planned_minutes.errors %}
                                <div class="text-danger">{{ form.planned_minutes.errors }}</div>
                                {% endif %}
                                <div class="form-text">Продолжительность заказа в минутах</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">Дополнительная информация</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.planned_date.id_for_label }}" class="form-label">Планируемая дата</label>
                        <input type="date" 
                            name="{{ form.planned_date.name }}" 
                            id="{{ form.planned_date.id_for_label }}" 
                            class="form-control"
                            value="{% if form.planned_date.value %}{{ form.planned_date.value|date:'Y-m-d' }}{% elif form.instance.planned_date %}{{ form.instance.planned_date|date:'Y-m-d' }}{% endif %}">
                        {% if form.planned_date.errors %}
                        <div class="text-danger">{{ form.planned_date.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.comment.id_for_label }}" class="form-label">Комментарий</label>
                        {{ form.comment }}
                        {% if form.comment.errors %}
                        <div class="text-danger">{{ form.comment.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="{% url 'index' %}" class="btn btn-secondary">Отмена</a>
        </form>
    </div>
</div>

<style>
    .form-label {
        font-weight: 500;
    }
    
    .form-control, .form-select {
        border-radius: 6px;
    }
    
    .card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card-header {
        background-color: #f8f9fa;
        font-weight: 600;
    }
</style>
{% endblock %}