{% load math_filters %}

<div id="planner-container">
    <div class="planner-container">
        <div class="planner-grid">
            {% for day in days %}
            <div class="planner-column {% if not day.is_work_day %}weekend{% endif %} {% if day.total_minutes > total_day_minutes %}over-limit{% endif %}" 
                data-date="{{ day.date|date:'Y-m-d' }}" data-total-minutes="{{ total_day_minutes }}">
                
                <!-- Индикатор превышения лимита -->
                {% if day.total_minutes > total_day_minutes %}
                <div class="overlay-limit">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <div>Превышение!</div>
                    </div>
                </div>
                {% endif %}
                               
                <div class="planner-header">
                    <h5>{{ day.date|date:"d.m" }}</h5>
                    <div class="text-muted small">{{ day.date|date:"l" }}</div>
                    <div class="time-usage small text-muted mt-1">
                        {{ day.total_minutes }} / {{ total_day_minutes }} мин.
                        {% if day.total_minutes > total_day_minutes %}
                        <span class="text-danger">(+{{ day.total_minutes|subtract:total_day_minutes }})</span>
                        {% endif %}
                    </div>
                    <div class="day-utilization" data-percentage="{{ day.day_percentage }}"></div>
                </div>
                
                <div class="orders-container" id="orders-{{ day.date|date:'Y-m-d' }}">
                    {% for order in day.orders %}
                    <div class="order-brick" data-order-id="{{ order.pk }}" data-minutes="{{ order.planned_minutes }}"
                        style="background-color: {{ order.color }}; height: {% widthratio order.planned_minutes total_day_minutes 300 %}px;"
                        title="{{ order.title }} - {{ order.customer.first_name }} ({{ order.planned_minutes }} мин.)">
                        
                        <a href="{% url 'order_detail' pk=order.pk %}" class="order-link">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        
                        <div class="order-content">
                            <h6>{{ order.title|truncatechars:20 }}</h6>
                            <p class="mb-1">{{ order.customer.first_name }}</p>
                            <span class="minutes-badge">{{ order.planned_minutes }} мин.</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-column-message">Нет заказов</div>
                    {% endfor %}
                </div>
                        
                <!-- Кнопка добавления заказа -->
                <div class="add-order-btn-container">
                    <a href="{% url 'order_create' %}?planned_date={{ day.date|date:'Y-m-d' }}" 
                       class="btn btn-outline-primary btn-sm w-100 add-order-btn" 
                       title="Добавить заказ на {{ day.date|date:'d.m.Y' }}">
                        <i class="fas fa-plus"></i> Добавить заказ
                    </a>
                </div>
                
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="unplanned-section">
    <h4><i class="fas fa-inbox"></i> Заказы без даты</h4>
    
    <div class="unplanned-grid" id="unplanned-orders">
        {% for order in orders_without_date %}
        <div class="order-brick" 
            data-order-id="{{ order.id }}"
            data-minutes="{{ order.planned_minutes }}"
            style="background-color: {{ order.color }}; height: {% widthratio order.planned_minutes total_day_minutes 300 %}px;">
            
            <a href="{% url 'order_detail' pk=order.pk %}" class="order-link" title="Открыть карточку заказа">
                <i class="fas fa-external-link-alt"></i>
            </a>
            
            <div class="order-content">
                <h6>{{ order.title|truncatechars:20 }}</h6>
                <p><i class="fas fa-user"></i> {{ order.customer.first_name }}</p>
                <span class="minutes-badge">{{ order.planned_minutes }} мин</span>
                
                {% if order.status %}
                <span class="badge status-badge bg-light text-dark">
                    {{ order.status.name }}
                </span>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p class="text-muted">Нет заказов без даты</p>
        {% endfor %}
    </div>
</div>