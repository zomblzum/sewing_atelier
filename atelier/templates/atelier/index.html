{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}Планировщик заказов{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
/* Обновленные стили для новой системы */
.planner-container {
    width: 100%;
    overflow-x: auto;
    margin: 20px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.planner-grid {
    display: flex;
    flex-direction: row;
    min-width: max-content;
    width: 100%;
    padding: 10px;
}

.planner-column {
    flex: 1;
    min-width: 180px;
    max-width: 200px;
    background: #f8f9fa;
    min-height: 500px; /* Увеличиваем для кнопки */
    border-right: 1px solid #dee2e6;
    padding: 10px;
    position: relative;
    display: flex;
    flex-direction: column;
}

.planner-column:last-child {
    border-right: none;
}

.planner-column.weekend {
    background: #e9ecef;
    opacity: 0.9;
}

.planner-header {
    text-align: center;
    margin-bottom: 15px;
    padding: 12px;
    background: white;
    border-bottom: 1px solid #dee2e6;
    position: relative;
    flex-shrink: 0;
}

.day-utilization {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 4px;
    background-color: #4CAF50;
    transition: width 0.3s ease;
}

.orders-container {
    min-height: 300px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex-grow: 1;
}

.order-brick {
    border-radius: 6px;
    padding: 10px;
    color: white;
    font-size: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    cursor: grab;
    border: none;
    transition: all 0.2s ease;
    width: 100%;
    box-sizing: border-box;
    min-height: 80px;
    position: relative;
    display: block;
    text-decoration: none;
}

.order-brick:active {
    cursor: grabbing;
    transform: rotate(2deg);
}

.order-brick:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    text-decoration: none;
    color: white;
}

.order-brick h6 {
    margin: 0 0 4px 0;
    font-size: 12px;
    font-weight: bold;
    line-height: 1.2;
}

.order-brick p {
    margin: 2px 0;
    font-size: 11px;
    line-height: 1.1;
}

.status-badge {
    font-size: 10px;
    padding: 2px 5px;
}

.unplanned-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-top: 30px;
    border: 1px solid #ddd;
}

.unplanned-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 15px;
}

/* Стили для Sortable */
.sortable-ghost {
    opacity: 0.4;
}

.sortable-chosen {
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.sortable-drag {
    opacity: 0.9;
}

.empty-column-message {
    color: #6c757d;
    font-size: 11px;
    text-align: center;
    margin-top: 20px;
}

.minutes-badge {
    font-size: 10px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    padding: 2px 6px;
    margin-top: 4px;
    display: inline-block;
}

.overlay-limit {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #d9534f;
    font-weight: bold;
    font-size: 14px;
    pointer-events: none;
    border: 2px dashed #d9534f;
    border-radius: 6px;
}

.order-link {
    position: absolute;
    top: 5px;
    right: 5px;
    color: white !important;
    opacity: 0.6;
    font-size: 10px;
    padding: 3px;
    border-radius: 3px;
    background: rgba(0, 0, 0, 0.3);
    transition: opacity 0.2s ease;
    z-index: 100;
    text-decoration: none;
}

.order-link:hover {
    opacity: 1;
    color: white !important;
    background: rgba(0, 0, 0, 0.5);
    text-decoration: none;
}

/* Улучшаем взаимодействие с ссылкой при перетаскивании */
.sortable-drag .order-link,
.sortable-ghost .order-link {
    display: none;
}

/* Стили для кнопки добавления заказа */
.add-order-btn-container {
    padding: 15px 0 5px 0;
    margin-top: auto;
    flex-shrink: 0;
}

.add-order-btn {
    border: 2px dashed #6c757d;
    background-color: rgba(108, 117, 125, 0.1);
    transition: all 0.3s ease;
    opacity: 0.8;
    color: #6c757d;
    padding: 8px 5px;
    font-size: 12px;
}

.add-order-btn:hover {
    background-color: rgba(13, 110, 253, 0.15);
    border-color: #0d6efd;
    color: #0d6efd;
    opacity: 1;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Навигация по неделям */
.week-navigation {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #dee2e6;
    margin-bottom: 20px;
}

.nav-btn-group {
    display: flex;
    gap: 8px;
    align-items: center;
}

.nav-btn-group .btn {
    white-space: nowrap;
}

.week-info {
    min-width: 200px;
}

/* Адаптивность */
@media (max-width: 768px) {
    .planner-column {
        min-width: 150px;
    }
    
    .add-order-btn {
        font-size: 11px;
        padding: 6px 3px;
    }
    
    .week-navigation {
        flex-direction: column;
        gap: 10px;
    }
    
    .nav-btn-group {
        justify-content: center;
    }
    
    .nav-btn-group .btn {
        font-size: 12px;
        padding: 5px 8px;
    }
}

/* Убираем дублирующиеся стили */
.order-content {
    pointer-events: none;
}

.order-content * {
    pointer-events: auto;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>Планировщик заказов</h1>
        <p class="text-muted mb-0">Неделя с {{ days.0.date|date:"d.m.Y" }}</p>
    </div>
    <div>
        <a href="{% url 'order_create' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Новый заказ
        </a>
    </div>
</div>

<!-- Навигация по неделям -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Левая часть - Прошлые недели -->
    <div class="d-flex align-items-center gap-2">
        <a href="#" class="btn btn-outline-primary btn-sm" data-action="add_left" title="Добавить прошлую неделю">
            <i class="fas fa-arrow-left"></i> Добавить прошлую
        </a>
        <a href="#" class="btn btn-outline-danger btn-sm" data-action="remove_left" title="Убрать прошлую неделю">
            <i class="fas fa-times"></i> Убрать
        </a>
    </div>
    
    <!-- Центр - Текущий вид -->
    <div class="text-center">
        <h4 class="mb-0">
            <span class="badge bg-secondary">
                <i class="fas fa-calendar"></i> 
                {% if weeks > 1 %}
                    {{ weeks }} недели
                {% else %}
                    Текущая неделя
                {% endif %}
            </span>
        </h4>
        <small class="text-muted">
            Неделя от {{ days.0.date|date:"d.m.Y" }}
        </small>
    </div>
    
    <!-- Правая часть - Будущие недели -->
    <div class="d-flex align-items-center gap-2">
        <a href="#" class="btn btn-outline-danger btn-sm" data-action="remove_right" title="Убрать будущую неделю">
            Убрать <i class="fas fa-times"></i>
        </a>
        <a href="#" class="btn btn-outline-primary btn-sm" data-action="add_right" title="Добавить будущую неделю">
            Добавить будущую <i class="fas fa-arrow-right"></i>
        </a>
    </div>
</div>

<!-- Кнопка сброса -->
<div class="text-center mb-3">
    <a href="#" class="btn btn-outline-secondary btn-sm" data-action="reset" title="Вернуться к текущей неделе">
        <i class="fas fa-sync"></i> Текущая неделя
    </a>
</div>

<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> Перетягивайте заказы в дни для планирования. Высота заказа соответствует его продолжительности.
</div>

<!-- Остальной код планера -->
<div id="planner-container">
    {% include 'atelier/planner_partial.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const utilizationBars = document.querySelectorAll('.day-utilization');
    utilizationBars.forEach(bar => {
        const percentage = bar.getAttribute('data-percentage');
        if (percentage) {
            bar.style.width = percentage + '%';
        }
    });    
    console.log('Инициализация планера...');
    if (typeof initializePlanner === 'function') {
        initializePlanner();
    }
});

// Также добавьте обработчик для кнопок вне Sortable
document.addEventListener('click', function(e) {
    if (e.target.closest('.order-link')) {
        e.stopPropagation();
    } else if (e.target.closest('[data-action]')) {
        e.preventDefault();
        const action = e.target.closest('[data-action]').getAttribute('data-action');
        manageWeeks(action);
    }
});

// Основная функция инициализации планера
function initializePlanner() {
    console.log('Переинициализация планера...');
    
    // 1. Инициализация незапланированных заказов
    const unplannedContainer = document.getElementById('unplanned-orders');
    if (unplannedContainer) {
        try {
            new Sortable(unplannedContainer, {
                group: {
                    name: 'orders',
                    pull: 'clone',
                    put: true
                },
                sort: true,
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function(evt) {
                    if (evt.to !== evt.from && evt.to.classList.contains('orders-container')) {
                        return;
                    }
                    
                    if (evt.from && evt.item) {
                        if (evt.to === evt.from) {
                            updateUnplannedOrderOrder(evt.to);
                        }
                    }
                }
            });
            console.log('Незапланированные заказы инициализированы');
        } catch (e) {
            console.error('Ошибка инициализации незапланированных заказов:', e);
        }
    }

    // 2. Инициализация всех колонок дней
    const dayColumns = document.querySelectorAll('.orders-container');
    
    dayColumns.forEach(container => {
        try {
            const columnElement = container.closest('.planner-column');
            const totalDayMinutes = parseInt(columnElement?.dataset?.totalMinutes || '480');
            
            new Sortable(container, {
                group: {
                    name: 'orders',
                    put: function(to, from, dragEl) {
                        try {
                            let totalMinutes = 0;
                            const children = to.children;
                            
                            if (!children) return true;
                            
                            for (let i = 0; i < children.length; i++) {
                                const child = children[i];
                                if (child.classList.contains('order-brick') && child !== dragEl) {
                                    const minutes = parseInt(child.dataset.minutes || '0');
                                    totalMinutes += minutes;
                                }
                            }
                            
                            const dragMinutes = parseInt(dragEl.dataset.minutes || '0');
                            totalMinutes += dragMinutes;
                            
                            if (totalMinutes > totalDayMinutes) {
                                alert('Превышен лимит времени в этом дне! Максимум: ' + totalDayMinutes + ' минут.');
                                return false;
                            }
                            
                            return true;
                        } catch (e) {
                            console.error('Ошибка проверки лимита:', e);
                            return true;
                        }
                    }
                },
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onAdd: function(evt) {
                    console.log('Заказ перемещен:', evt.item.dataset.orderId);
                    const orderId = evt.item.dataset.orderId;
                    const columnElement = evt.to.closest('.planner-column');
                    if (!orderId || !columnElement) return;
                    
                    const date = columnElement.dataset.date;
                    
                    const orders = evt.to.querySelectorAll('.order-brick');
                    let orderInDay = Array.from(orders).indexOf(evt.item);
                    
                    if (orderInDay >= 0) {
                        updateOrderPlanning(orderId, date, orderInDay);
                    }
                },
                onUpdate: function(evt) {
                    const columnElement = evt.to.closest('.planner-column');
                    if (!columnElement) return;
                    
                    const date = columnElement.dataset.date;
                    
                    const orders = evt.to.querySelectorAll('.order-brick');
                    if (orders && orders.length > 0) {
                        orders.forEach((order, index) => {
                            const orderId = order.dataset.orderId;
                            if (orderId) {
                                updateOrderPlanning(orderId, date, index);
                            }
                        });
                    }
                },
                onRemove: function(evt) {
                    if (evt.to && evt.to.id === 'unplanned-orders') {
                        const orderId = evt.item.dataset.orderId;
                        if (orderId) {
                            updateOrderPlanning(orderId, null, null);
                        }
                    }
                }
            });
        } catch (e) {
            console.error('Ошибка инициализации колонки:', e);
        }
    });
    
    console.log('Планировщик полностью переинициализирован');
}

// Функция загрузки дополнительных недель
function loadMoreWeeks(direction) {
    const urlParams = new URLSearchParams(window.location.search);
    let currentWeeks = parseInt(urlParams.get('weeks') || 1);
    let startDate = urlParams.get('start_date');
    let newStartDate = startDate;
    
    // Если start_date не указан, используем текущую дату
    if (!startDate) {
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
        startDate = startOfWeek.toISOString().split('T')[0];
        newStartDate = startDate;
    }
    
    if (direction === 'left') {
        // Добавляем неделю слева - смещаем start_date на 7 дней назад
        const currentStartDate = new Date(startDate);
        currentStartDate.setDate(currentStartDate.getDate() - 7);
        newStartDate = currentStartDate.toISOString().split('T')[0];
        currentWeeks += 1;
    } else if (direction === 'right') {
        // Добавляем неделю справа
        currentWeeks += 1;
    } else if (direction === 'remove' && currentWeeks > 1) {
        currentWeeks -= 1;
    } else {
        return;
    }
    
    // Обновляем страницу с новыми параметрами
    window.location.href = `?start_date=${newStartDate}&weeks=${currentWeeks}`;
}

function manageWeeks(action) {
    const urlParams = new URLSearchParams(window.location.search);
    let currentWeeks = parseInt(urlParams.get('weeks') || '1');
    let startDate = urlParams.get('start_date');
    
    // Безопасная обработка даты
    if (!startDate) {
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
        startDate = startOfWeek.toISOString().split('T')[0];
    }
    
    let newStartDate = startDate;
    
    // Если start_date не указан, используем текущую дату
    if (!startDate) {
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
        startDate = startOfWeek.toISOString().split('T')[0];
        newStartDate = startDate;
    }
    
    switch (action) {
        case 'add_left':
            // Добавляем неделю слева - смещаем start_date на 7 дней назад
            const currentStartDate = new Date(startDate);
            currentStartDate.setDate(currentStartDate.getDate() - 7);
            newStartDate = currentStartDate.toISOString().split('T')[0];
            currentWeeks += 1;
            break;
            
        case 'add_right':
            // Добавляем неделю справа
            currentWeeks += 1;
            break;
            
        case 'remove_left':
            // Убираем неделю слева - смещаем start_date на 7 дней вперед
            if (currentWeeks > 1) {
                const currentStartDate = new Date(startDate);
                currentStartDate.setDate(currentStartDate.getDate() + 7);
                newStartDate = currentStartDate.toISOString().split('T')[0];
                currentWeeks -= 1;
            }
            break;
            
        case 'remove_right':
            // Убираем неделю справа
            if (currentWeeks > 1) {
                currentWeeks -= 1;
            }
            break;
            
        case 'reset':
            // Сброс к текущей неделе
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
            newStartDate = startOfWeek.toISOString().split('T')[0];
            currentWeeks = 1;
            break;
            
        default:
            return;
    }
    
    // Обновляем страницу с новыми параметрами
    window.location.href = `?start_date=${newStartDate}&weeks=${currentWeeks}`;
}

// Функция загрузки текущей недели
function loadCurrentWeek() {
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
    const startDate = startOfWeek.toISOString().split('T')[0];
    
    window.location.href = `?start_date=${startDate}&weeks=1`;
}

// Функция обновления планирования заказа
function updateOrderPlanning(orderId, date, orderInDay) {
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start_date');
    const weeks = urlParams.get('weeks');
    
    // Преобразуем orderInDay в число или null
    let orderInDayValue = orderInDay;
    if (orderInDay === null || orderInDay === undefined || orderInDay === '') {
        orderInDayValue = null;
    } else {
        orderInDayValue = parseInt(orderInDay);
    }
    
    fetch('{% url "update_order_planning" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            order_id: orderId,
            planned_date: date,
            order_in_day: orderInDayValue,
            start_date: startDate,
            weeks: weeks
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.html) {
                // Заменяем ВЕСЬ контент страницы
                document.documentElement.innerHTML = data.html;
                // Переинициализируем планер после замены контента
                setTimeout(() => {
                    if (typeof initializePlanner === 'function') {
                        initializePlanner();
                    }
                }, 100);
            } else {
                // Fallback: перезагрузка страницы
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            }
        } else {
            alert('Ошибка при обновлении заказа: ' + data.error);
            setTimeout(() => {
                window.location.reload();
            }, 300);
        }
    })
    .catch(error => {
        console.error('Ошибка сети:', error);
        alert('Ошибка сети: ' + error);
        setTimeout(() => {
            window.location.reload();
        }, 300);
    });
}

// Функция обновления порядка в "без даты"
function updateUnplannedOrderOrder(container) {
    const orders = container.querySelectorAll('.order-brick');
    console.log('Обновление порядка в "без даты"');
    // Здесь можно добавить логику для сохранения порядка
}

console.log('JavaScript планера загружен');
</script>
{% endblock %}